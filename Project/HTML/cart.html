<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>

    <link rel="stylesheet" href="../CSS/font-awesome/font-awesome.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="../CSS/bootstrap-5.0.2-dist/css/bootstrap.min.css">
    <script src="../CSS/bootstrap-5.0.2-dist/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="../CSS/allmain.css">
    <link rel="stylesheet" href="../CSS/normalize.css">
    <link rel="stylesheet" href="../CSS/header.css">
    <link rel="stylesheet" href="../CSS/bannerDetails.css">
    <link rel="stylesheet" href="../CSS/cart.css">
    <link rel="stylesheet" href="../CSS/productCount.css">
</head>

<body>

    <!--================Header Menu Area =================-->
    <header class="header_area">

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
          <div class="container">
    
            <a class="navbar-brand logo_h" href="index.html">
              <img src="../MEDIA/2.jpg" alt="" height="80"/>
            </a>
    
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
    
            <div class="collapse navbar-collapse offset w-100" id="navbarSupportedContent">
              <div class="row w-100 mr-0">
                <div class="col-md-10">
                  <div class="d-flex form-inputs">
                    <form class="d-flex m-auto" action="search.html" method="get">
                      <input class="form-control me-2" style="align-self: center ;" type="search" placeholder="Search"
                        aria-label="Search" required name="searchProduct" value="">
                      <button class="btn" type="submit">
                        <i style=" font-size: large;" class="fa fa-search" aria-hidden="true"></i>
                      </button>
                    </form>
    
                  </div>
                </div>
              </div>
            </div>
    
            <div class="col-lg-5 pr-0">
              <ul class="nav navbar-nav navbar-right right_nav pull-right">
    
                <li class="nav-item">
                  <a class="icons" onclick="var user=localStorage.getItem('user'); if(user!=null){window.open('newProduct.html','_blank')}else{window.open('tgroba.html')}">
                    <i style="position: relative; font-size: x-large;" class="fa fa-plus" id="newProduct">
                    </i>
                  </a>
                </li>
    
                <li class="nav-item">
                  <a class="icons"onclick="var user=localStorage.getItem('user'); if(user!=null){window.open('cart.html','_blank')}else{window.open('tgroba.html')}">
                    <i style="position: relative; font-size: x-large;" class="fa fa-shopping-cart" id="cartIcon">
                    </i>
                  </a>
                </li>
    
                <li class="nav-item">
                  <a onclick="var user=localStorage.getItem('user'); if(user!=null){window.open('favorites.html','_blank')}else{window.open('tgroba.html')}" class="icons">
                    <i style="position: relative; font-size: x-large;" class="fa fa-heart" id="favIcon">
                    </i>
                  </a>
                </li>
    
                <li class="nav-item">
                  <a onclick="var user=localStorage.getItem('user'); if(user!=null){window.open('settings.html','_blank')}else{window.open('tgroba.html')}" class="icons">
                    <i style="position: relative; font-size: x-large;" class="fa fa-user" aria-hidden="true"></i>
                  </a>
                </li>
    
              </ul>
            </div>
          </div>
          </div>
          </div>
        </nav>
    
      </header>
    <!--================Header Menu Area =================-->

    <!--================Home Banner Area =================-->
    <section class="banner_area mb-5">
        <div class="banner_inner d-flex align-items-center">
            <div class="container">
                <div class="banner_content d-md-flex justify-content-between align-items-center">
                    <div class="mb-3 mb-md-0">
                        <span class="h2 me-3 ms-3">Cart</span>
                        <i style="position: relative; font-size: 40px; color:#71cd14;" class="fa fa-shopping-cart ">
                        </i>
                    </div>
                    <div class="page_link">
                        <a href="index.html">Home</a>
                        <a href="cart.html"> Cart</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--================End Home Banner Area =================-->

    <!--================Cart Area =================-->
    <section class="cart_area">
        <div class="container">
            <div class="cart_inner">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Product</th>
                                <th scope="col">Price</th>
                                <!-- <th scope="col">Quantity</th>
                                <th scope="col">Total</th> -->
                            </tr>
                        </thead>
                        <tbody id="tableBody">

                            <tr class="bottom_button">
                                <!-- <td>
                                    <a class="gray_btn" href="#" onclick="updateData()">Update Cart</a>
                                </td> -->
                                <td></td>
                                <td></td>
                                <td>
                                    <div class="cupon_text">
                                        <input type="text" placeholder="Coupon Code" />
                                        <a class="main_btn" href="#">Apply</a>
                                        <a class="gray_btn" href="#">Close Coupon</a>
                                    </div>
                                </td>
                            </tr>

                            <tr class="out_button_area">
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>
                                    <div class="checkout_btn_inner">
                                        <a class="gray_btn" href="index.html">Continue Shopping</a>
                                        <a class="main_btn" href="checkout.html">Proceed to checkout</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
    <!--================End Cart Area =================-->

    <script>
        var products = [];
        var allProducts = [];
        var cartsCount = [];
        function drawTableContent() {
            console.log("===table==", products)
            for (const i in products) {
                var tableRow = document.createElement("tr");

                // First td =============
                var firstTd = document.createElement("td");
                var media = document.createElement("div");
                media.classList.add("media");
                var imageClass = document.createElement("div");
                imageClass.classList.add("d-flex");
                var imageTable = document.createElement("img");
                imageTable.src = `${products[i].image}`;
                imageTable.height = "90"; imageTable.width = "160"
                imageClass.append(imageTable);
                var mediaBody = document.createElement("div");
                mediaBody.classList.add("media-body");
                var name = document.createElement("p");
                name.innerText = products[i].name;
                mediaBody.append(name);
                media.append(imageClass, mediaBody);
                firstTd.append(media)

                // Seconde td ============
                var secondTd = document.createElement("td");
                var spanPound = document.createElement("span")
                spanPound.innerHTML = ""
                var price = document.createElement("div");
                price.setAttribute("id", "price");
                price.classList.add("h5");
                price.innerHTML = `&pound; ${products[i].price}`;
                secondTd.append(spanPound,price);

                //Third td ===================
                var thirddTd = document.createElement("td");
                // Div
                var productCount = document.createElement("div");
                productCount.classList.add("product_count");
                // input count
                // var inputCount = document.createElement("input");
                // inputCount.setAttribute("type", "text");
                // inputCount.setAttribute("name", "qty");
                // inputCount.setAttribute("disabled", "true")
                // inputCount.setAttribute("id", `sst`);
                // inputCount.setAttribute("value", `${cartsCount[i].count}`);
                // inputCount.setAttribute("title", "Quantity:");
                // // inputCount.setAttribute("onchange", "changeCount(this)")
                // inputCount.classList.add("input-text", "qty");
                // //increase button
                // var increaseQuantity = document.createElement("button");
                // increaseQuantity.setAttribute("id", `${products[i].id}`);
                // increaseQuantity.setAttribute("onclick", "var result = document.getElementById('sst'); var sst = result.value; if( !isNaN( sst )) result.value++;return false;console.log(this); ");
                // increaseQuantity.classList.add("increase", "items-count");
                // increaseQuantity.setAttribute("type", "button");
                // var increaseIcon = document.createElement("i");
                // increaseIcon.classList.add("fa", "fa-chevron-up");
                // increaseQuantity.append(increaseIcon);
                // // Decrease button
                // var reduceQuantity = document.createElement("button");
                // reduceQuantity.setAttribute("id", `${products[i].id}`);
                // reduceQuantity.setAttribute("onclick", "reduceFun(this)");
                // reduceQuantity.classList.add("reduced", "items-count");
                // reduceQuantity.setAttribute("type", "button");
                // var reduceIcon = document.createElement("i");
                // reduceIcon.classList.add("fa", "fa-chevron-down");
                // reduceQuantity.append(reduceIcon);

                // productCount.append(inputCount, increaseQuantity, reduceQuantity);
                // thirddTd.append(productCount);

                ///////// fourth td
                // var fourthTd = document.createElement("td");
                // var totlaPrice = document.createElement("div");
                // totlaPrice.classList.add("h5");
                // totlaPrice.setAttribute("id", "totalPrice");
                // totlaPrice.innerHTML = `&pound; ${products[i].price * cartsCount[i].count}`;
                // fourthTd.append(totlaPrice);

                tableRow.append(firstTd, secondTd);
                document.getElementById("tableBody").prepend(tableRow);

            }
        }

        function reduceFun(btnReduce) {
            var result =document.getElementById(btnReduce.id);
            var sst = result.value;
            var currentPrice = document.getElementById("price").innerText;
            var totalPrice = document.getElementById("totalPrice");
            if (!isNaN(sst) && sst > 0) {
                result.value--;
                // totalPrice.innerText = result.value * currentPrice;
            }
            for (const i in cartsCount) {
                if (cartsCount[i].id == btnReduce.id) {
                    if (result.value == 0) {
                        cartsCount[i].count = 0;
                        products[i].in_cart = false;
                    } else {
                        cartsCount[i].count = parseInt(result.value);
                        products[i].in_cart = true;
                    }
                }
            }
        }


        function increaseFun(btnReduce) {
            var result =document.getElementById(btnReduce.id);
            var sst = result.value;
            var currentPrice = document.getElementById("price").innerText;
            var totalPrice = document.getElementById("totalPrice");

            result.value++;
            totalPrice.innerText = result.value * currentPrice;
            for (const i in cartsCount) {
                if (cartsCount[i].id == btnReduce.id) {
                    cartsCount[i].count = parseInt(result.value);
                    products[i].in_cart = true;
                }
            }
        }
        async function fetchCarts() {
            const response = await fetch("http://localhost:3005/cartCounts")
                .then((response) => response.json())
                .then((data) => {
                    if (data.carts.length > 0) {
                        for (var i in data.carts) {
                            cartsCount[i] = data.carts[i];
                        }
                    }
                    fetchMovies()
                });
        }

        fetchCarts();

        async function fetchMovies() {
            var url;
            url = "http://localhost:3005/data-en";
            const response = await fetch(url)
                .then((response) => response.json())
                .then((data) => {
                    for (const i in data.products) {
                        allProducts[i] = data.products[i];
                    }
                    for (const cart of cartsCount) {
                        for (const product of data.products) {
                            if (product.id == cart.id) {
                                products.push(product);
                            }
                        }
                    }
                    drawTableContent();

                });
        }

        async function updateCartsCount(carts) {
            console.log("=========== Carts========= ",carts)
            const response = await fetch("http://localhost:3005/cartCounts", {
                method: "POST",
                body: JSON.stringify(...carts)
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log(data)
                });
        }


        async function updateCartProducts() {
            url = "http://localhost:3005/data-en";
            const response = await fetch(url, {
                method: "PATCH",
                body: JSON.stringify(allProducts)
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log(data)
                });
        }

        async function updateData() {
            for (const i in products) {
                if (allProducts[i].id == products[i].id) {
                    allProducts[i] = products[i];
                }
            }

            console.log("===============================",cartsCount)
      
            // const response = await fetch("http://localhost:3005/cartCounts", {
            //     method: "PATCH",
            //     body: JSON.stringify(carts)
            // })
            //     .then((response) => response.json())
            //     .then((data) => {
            //         console.log(data)
            //     });

            // console.log("====all products ==== ",allProducts);
            // console.log("====all Cars ==== ",carts);
            // console.log("==== products ==== ",products);
            updateCartsCount(cartsCount);
            // updateCartProducts(allProducts);
        }
        console.log("=========", products)


    </script>
</body>

</html>